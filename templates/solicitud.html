{% extends 'base.html' %}

{% block contenido %}

<div style="max-width: 600px; margin: 0 auto; padding: 20px;">

    <h2 style="font-size: 22px; margin-bottom: 20px; font-weight: normal;">Solicitud de Pedido</h2>

    {% if producto %}
    <div style="background: #e8f4f8; border: 1px solid #b3dfe5; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
        <p style="margin: 0 0 5px 0;"><strong>Producto:</strong> {{ producto.nombre }}</p>
        <p style="margin: 0;">Precio base: <strong>${{ producto.precio_base }}</strong></p>
    </div>
    {% endif %}

    <form id="solicitud-form" method="POST" action="{% url 'solicitud_producto' producto.id %}" enctype="multipart/form-data" style="background: white; border: 1px solid #ddd; padding: 20px; border-radius: 4px;">
        {% csrf_token %}

        <h4 style="font-size: 16px; margin-bottom: 15px; font-weight: bold;">Datos del Cliente</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px;">{{ form.cliente_nombre.label }}</label>
                {{ form.cliente_nombre }}
                {% if form.cliente_nombre.errors %}
                    <div style="color: #d9534f; font-size: 12px; margin-top: 3px;">{{ form.cliente_nombre.errors }}</div>
                {% endif %}
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px;">{{ form.cliente_email.label }}</label>
                {{ form.cliente_email }}
                {% if form.cliente_email.errors %}
                    <div style="color: #d9534f; font-size: 12px; margin-top: 3px;">{{ form.cliente_email.errors }}</div>
                {% endif %}
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px;">{{ form.cliente_telefono.label }}</label>
                {{ form.cliente_telefono }}
                {% if form.cliente_telefono.errors %}
                    <div style="color: #d9534f; font-size: 12px; margin-top: 3px;">{{ form.cliente_telefono.errors }}</div>
                {% endif %}
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px;">{{ form.cliente_red_social.label }}</label>
                {{ form.cliente_red_social }}
                {% if form.cliente_red_social.errors %}
                    <div style="color: #d9534f; font-size: 12px; margin-top: 3px;">{{ form.cliente_red_social.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px;">{{ form.plataforma_origen.label }}</label>
            {{ form.plataforma_origen }}
            {% if form.plataforma_origen.errors %}
                <div style="color: #d9534f; font-size: 12px; margin-top: 3px;">{{ form.plataforma_origen.errors }}</div>
            {% endif %}
            <small style="display: block; color: #999; margin-top: 5px; font-size: 12px;">Selecciona la plataforma desde la cual realizas la solicitud (administrable desde el panel).</small>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

        <h4 style="font-size: 16px; margin-bottom: 15px; font-weight: bold;">Detalles de la Solicitud</h4>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px;">{{ form.descripcion_solicitud.label }}</label>
            {{ form.descripcion_solicitud }}
            {% if form.descripcion_solicitud.errors %}
                <div style="color: #d9534f; font-size: 12px; margin-top: 3px;">{{ form.descripcion_solicitud.errors }}</div>
            {% endif %}
            <small style="display: block; color: #999; margin-top: 5px; font-size: 12px;">Cuéntanos qué necesitas o cómo deseas tu producto personalizado</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: normal; font-size: 14px;">{{ form.fecha_requerida.label }}</label>
            {{ form.fecha_requerida }}
            {% if form.fecha_requerida.errors %}
                <div style="color: #d9534f; font-size: 12px; margin-top: 3px;">{{ form.fecha_requerida.errors }}</div>
            {% endif %}
            <small style="display: block; color: #999; margin-top: 5px; font-size: 12px;">(Opcional) ¿Cuándo necesitas tu pedido?</small>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

        <h4 style="font-size: 16px; margin-bottom: 15px; font-weight: bold;">Imágenes de Referencia</h4>
        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Sube imágenes que muestren lo que deseas. Puedes cargar varios archivos.</p>

        {{ formset.management_form }}

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            {% for f in formset %}
            <div>
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: normal; font-size: 14px;">Imagen {{ forloop.counter }}</label>
                    {{ f.imagen }}
                    {% if f.imagen.errors %}
                        <div style="color: #d9534f; font-size: 12px; margin-top: 5px;">{{ f.imagen.errors }}</div>
                    {% endif %}
                    <small style="display: block; color: #999; margin-top: 5px; font-size: 12px;">Formato: JPG, PNG, GIF. Máx. 5MB</small>
                </div>
            </div>
            {% endfor %}
        </div>

        <div style="margin-top: 30px;">
            <button type="submit" style="display: block; width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-bottom: 10px;">
                Enviar Solicitud
            </button>
            <a href="{% url 'producto_detalle' producto.slug %}" style="display: block; width: 100%; padding: 12px; background: white; color: #333; text-decoration: none; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 16px; box-sizing: border-box;">
                Volver al Producto
            </a>
        </div>

    </form>

</div>

<script>
(() => {
    const form = document.getElementById('solicitud-form');
    if (!form) return;

    const submitButton = form.querySelector('button[type="submit"]');

    // Prevent double submission: set a flag on the first submit and disable the button.
    form.addEventListener('submit', function (e) {
        if (form.__submitted) {
            // If already submitted, prevent any further submission.
            e.preventDefault();
            return false;
        }
        try {
            form.__submitted = true;
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.style.opacity = 0.7;
            }
        } catch (err) {
            // ignore
        }
        return true;
    });
})();
</script>

{% endblock %}
